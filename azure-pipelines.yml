parameters:
  - name: versionSpec
    type: object
    default:
    #- '6.x'
    - '8.x'
    - '10.x'
    - '12.x'
    - '14.x'

jobs:
#build client on Node 8.x
  - job: build
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '8.x'
      displayName: Install node

    - script: npm install
      displayName: npm install

    - script: npm run build
      displayName: npm run build

  #test client on different node versions
  - job: unit_tests
    dependsOn: build
    steps: 
    - ${{ each version in parameters.versionSpec }}:
      - task: NodeTool@0
        inputs:
          versionSpec: ${{ version }}
        displayName: Install node
      - script: npm install
        displayName: npm install
      - script: npm run units
        displayName: npm run units
      - script: npm run test
        displayName: npm run test

  #build and publish
  - job: publish
    dependsOn: unit_tests
    condition: and(succeeded(), eq(dependencies.unit_tests.result, 'Succeeded'), in(variables['publishBuild'], 'true'))
    steps:
    - task: PublishBuildArtifacts@1
      condition: and(succeeded(), in(variables['publishBuild'], 'true'))
      inputs:
        PathtoPublish: "_build"
        ArtifactName: "drop"
        ArtifactType: "Container"
      displayName: Publish build artifacts
