parameters:
  - name: versionSpec
    type: string
    default: '8.x'
    values: 
      - '6.x'
      - '8.x'
      - '10.x'
      - '12.x'
      - '14.x'
jobs:
#build client on Node 8.x
  - job: build_and_publish
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '8.x'
      displayName: Install node

    - script: npm install
      displayName: npm install

    - script: npm run build
      displayName: npm run build
      
  #test client on different node versions
  - ${{each thing in parameters.versionSpec}}:
    - job: unit_tests
      steps: 
      - task: NodeTool@0
        inputs:
          versionSpec: ${{ parameters.versionSpec }}
        displayName: Install node
      - script: npm run units
        displayName: npm run units
      - script: npm run test
        displayName: npm run test

  #build and publish
  - job: build_and_publish
    dependsOn: unit_tests
    condition: and(succeeded(), eq(dependencies.unit_tests.result, 'Succeeded'), in(variables['publishBuild'], 'true'))
    steps:
    - task: PublishBuildArtifacts@1
      condition: and(succeeded(), in(variables['publishBuild'], 'true'))
      inputs:
        PathtoPublish: "_build"
        ArtifactName: "drop"
        ArtifactType: "Container"
      displayName: Publish build artifacts
